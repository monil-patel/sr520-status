<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SR 520 Bridge Status</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
    <div id="app" class="max-w-2xl mx-auto p-6">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-slate-100 mb-2">SR 520 Bridge Status</h1>
            <p class="text-slate-400">Can I drive across the bridge?</p>
        </div>

        <!-- Main Status Badge -->
        <div id="status" class="mb-8">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- Details (only if there are closures) -->
        <div id="details" class="mb-6">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- Footer -->
        <div id="footer" class="text-slate-400 text-sm text-center mt-8">
            <p>Data from <a href="https://sr520construction.com" target="_blank" class="text-blue-400 hover:underline">SR 520 Construction Corner</a></p>
            <p id="last-updated" class="mt-2">Loading...</p>
            <button onclick="fetchSR520Data()" 
                    class="mt-4 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-colors">
                üîÑ Refresh
            </button>
        </div>
    </div>

    <script>
        const CORS_PROXY = 'https://corsproxy.io/?';
        const SR520_URL = 'https://sr520construction.com/';

        async function fetchSR520Data() {
            try {
                showLoading();
                
                // Fetch the page through CORS proxy
                const response = await fetch(CORS_PROXY + encodeURIComponent(SR520_URL));
                const html = await response.text();
                
                // Parse HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Extract closures
                const closures = extractClosures(doc);
                
                // Update UI
                updateUI(closures);
                
            } catch (error) {
                console.error('Error fetching SR 520 data:', error);
                showError();
            }
        }

        function isBridgeBlocked(description) {
            const lower = description.toLowerCase();
            
            // Keywords that mean the BRIDGE itself is closed (based on real WSDOT phrases)
            const bridgeBlockedKeywords = [
                // Both directions - from real examples
                'sr 520 closed in both directions',
                'sr 520 will close in both directions',
                'sr 520 will be closed in both directions',
                '520 closed in both directions',
                '520 will close in both directions',
                
                // Eastbound closures - from real examples
                'eastbound sr 520 closed between',
                'eastbound sr 520 will close',
                'eastbound sr 520 will be closed',
                'eastbound 520 closed between',
                'eastbound sr 520 between',  // "Eastbound SR 520 between I-5 and Montlake will close"
                'eastbound lanes of sr 520',
                'all eastbound lanes',
                
                // Westbound closures - from real examples
                'westbound sr 520 closed',
                'westbound sr 520 will close',
                'westbound sr 520 will be closed',
                'westbound 520 closed',
                'westbound sr 520 between',  // "Westbound SR 520 between 92nd and I-5 will be closed"
                'westbound lanes of sr 520',
                'all westbound lanes',
                
                // Across lake variants - from real examples
                'closed across lake washington',
                '520 closed across lake',
                'sr 520 closed across',
                
                // General activity types
                'full highway closure',
                'complete highway closure'
            ];
            
            // Exclude if it's NOT the bridge (ramps, exits, streets)
            const notBridgeKeywords = [
                'off-ramp',
                'on-ramp',
                'ramp to',
                'ramp from',
                'exit',
                'entrance',
                'street',
                'st.',
                'ave',
                'avenue',
                'blvd',
                'boulevard',
                'trail',
                'path',
                'sidewalk'
            ];
            
            // First check: if it contains non-bridge keywords, it's NOT a bridge closure
            if (notBridgeKeywords.some(keyword => lower.includes(keyword))) {
                return false;
            }
            
            // Second check: does it match any bridge closure patterns?
            return bridgeBlockedKeywords.some(keyword => lower.includes(keyword));
        }

        function extractClosures(doc) {
            const closures = {
                today: [],
                upcoming: [],
                bridgeBlockedToday: false,
                bridgeBlockedUpcoming: false
            };

            // Find "Closures today" section
            const headers = Array.from(doc.querySelectorAll('h2'));
            const todayHeader = headers.find(h => h.textContent.includes('Closures today'));
            
            if (todayHeader) {
                let nextEl = todayHeader.nextElementSibling;
                while (nextEl && !nextEl.matches('h2')) {
                    const links = nextEl.querySelectorAll('a');
                    links.forEach(link => {
                        const text = link.textContent.trim();
                        const href = link.getAttribute('href');
                        if (text && href) {
                            const blocked = isBridgeBlocked(text);
                            if (blocked) {
                                closures.bridgeBlockedToday = true;
                            }
                            closures.today.push({
                                description: text,
                                link: href.startsWith('http') ? href : 'https://sr520construction.com' + href,
                                bridgeBlocked: blocked
                            });
                        }
                    });
                    nextEl = nextEl.nextElementSibling;
                    if (nextEl && nextEl.matches('h2')) break;
                }
            }

            // Find "Upcoming closures" section
            const upcomingHeader = headers.find(h => h.textContent.includes('Upcoming closures'));
            
            if (upcomingHeader) {
                let nextEl = upcomingHeader.nextElementSibling;
                while (nextEl && !nextEl.matches('h2, footer')) {
                    const links = nextEl.querySelectorAll('a');
                    links.forEach(link => {
                        const text = link.textContent.trim();
                        const href = link.getAttribute('href');
                        if (text && href && !closures.today.find(c => c.description === text)) {
                            const blocked = isBridgeBlocked(text);
                            if (blocked) {
                                closures.bridgeBlockedUpcoming = true;
                            }
                            closures.upcoming.push({
                                description: text,
                                link: href.startsWith('http') ? href : 'https://sr520construction.com' + href,
                                bridgeBlocked: blocked
                            });
                        }
                    });
                    nextEl = nextEl.nextElementSibling;
                    if (!nextEl || nextEl.matches('footer')) break;
                }
            }

            return closures;
        }

        function updateUI(closures) {
            const statusEl = document.getElementById('status');
            const detailsEl = document.getElementById('details');
            const lastUpdatedEl = document.getElementById('last-updated');

            // THE BIG ANSWER: Can you use the bridge?
            if (closures.bridgeBlockedToday) {
                // Bridge is BLOCKED today
                statusEl.innerHTML = `
                    <div class="bg-red-900/30 border-4 border-red-500 rounded-2xl p-12 text-center shadow-2xl">
                        <div class="text-8xl mb-4">üö´</div>
                        <div class="text-5xl font-bold text-red-400 mb-4">BRIDGE CLOSED</div>
                        <div class="text-2xl text-red-200 mb-6">SR 520 is blocked today</div>
                        <div class="text-xl text-red-300 bg-red-950/50 rounded-lg p-4 inline-block">
                            Use I-90 instead
                        </div>
                    </div>
                `;
            } else {
                // Bridge is OPEN
                statusEl.innerHTML = `
                    <div class="bg-green-900/30 border-4 border-green-500 rounded-2xl p-12 text-center shadow-2xl">
                        <div class="text-8xl mb-4">‚úÖ</div>
                        <div class="text-5xl font-bold text-green-400 mb-4">BRIDGE OPEN</div>
                        <div class="text-2xl text-green-200 mb-2">You can drive across SR 520</div>
                        ${closures.today.length > 0 ? 
                            `<div class="text-lg text-green-300 mt-4">‚ö†Ô∏è Some ramps/exits affected (see below)</div>` : 
                            `<div class="text-lg text-green-300 mt-4">No closures today</div>`
                        }
                    </div>
                `;
            }

            // Build 7-day forecast
            const forecast = build7DayForecast(closures);
            const forecastHTML = `
                <div class="bg-slate-800 border-2 border-slate-600 rounded-lg p-6 mb-6">
                    <h2 class="text-xl font-bold text-slate-100 mb-4 text-center">7-Day Bridge Forecast</h2>
                    <div class="grid grid-cols-7 gap-2">
                        ${forecast.map(day => `
                            <div class="text-center">
                                <div class="text-xs text-slate-400 mb-2 font-medium">${day.dayName}</div>
                                <div class="text-xs text-slate-500 mb-2">${day.date}</div>
                                <div class="${day.blocked ? 'bg-red-900/50 border-2 border-red-500' : 'bg-green-900/30 border-2 border-green-600'} rounded-lg p-3">
                                    <div class="text-3xl mb-1">${day.blocked ? 'üö´' : '‚úÖ'}</div>
                                    <div class="${day.blocked ? 'text-red-400' : 'text-green-400'} text-xs font-bold">
                                        ${day.blocked ? 'CLOSED' : 'OPEN'}
                                    </div>
                                </div>
                                ${day.closures.length > 0 ? `
                                    <div class="text-xs text-slate-400 mt-2">
                                        ${day.blocked ? `${day.closures.length} closure${day.closures.length > 1 ? 's' : ''}` : 
                                                       `${day.closures.length} ramp${day.closures.length > 1 ? 's' : ''}`}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                    <div class="text-xs text-slate-500 text-center mt-4">
                        Click a day below for details
                    </div>
                </div>
            `;

            // Show details if there are any closures
            let detailsHTML = forecastHTML;

            if (closures.today.length > 0 || closures.upcoming.length > 0) {
                // Today's closures details
                if (closures.today.length > 0) {
                    detailsHTML += `
                        <div class="bg-slate-800 border border-slate-600 rounded-lg p-6 mb-4">
                            <h2 class="text-xl font-bold text-slate-100 mb-4">üìã Today's Activity</h2>
                            <div class="space-y-2">
                                ${closures.today.map(closure => `
                                    <a href="${closure.link}" target="_blank" 
                                       class="block p-3 bg-slate-700/50 hover:bg-slate-700 rounded border border-slate-600 hover:border-blue-400 transition-all">
                                        ${closure.bridgeBlocked ? 
                                            `<div class="text-red-400 font-bold mb-1">üö´ BRIDGE BLOCKED</div>` : 
                                            `<div class="text-blue-400 text-sm mb-1">‚ÑπÔ∏è Ramp/Exit closure only</div>`
                                        }
                                        <div class="text-slate-200">${closure.description}</div>
                                        <div class="text-xs text-slate-400 mt-1">Click for details ‚Üí</div>
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                // Upcoming closures
                if (closures.upcoming.length > 0) {
                    // Show upcoming bridge closures prominently
                    const upcomingBridgeClosures = closures.upcoming.filter(c => c.bridgeBlocked);
                    const upcomingMinor = closures.upcoming.filter(c => !c.bridgeBlocked);

                    if (upcomingBridgeClosures.length > 0) {
                        detailsHTML += `
                            <div class="bg-red-900/20 border border-red-500/50 rounded-lg p-6 mb-4">
                                <h2 class="text-xl font-bold text-red-400 mb-4">‚ö†Ô∏è Upcoming Bridge Closures</h2>
                                <div class="space-y-2">
                                    ${upcomingBridgeClosures.map(closure => `
                                        <a href="${closure.link}" target="_blank" 
                                           class="block p-3 bg-red-900/30 hover:bg-red-900/50 rounded border border-red-500/50 hover:border-red-500 transition-all">
                                            <div class="text-red-400 font-bold mb-1">üö´ BRIDGE WILL BE CLOSED</div>
                                            <div class="text-slate-200">${closure.description}</div>
                                            <div class="text-xs text-slate-400 mt-1">Click for dates/times ‚Üí</div>
                                        </a>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }

                    if (upcomingMinor.length > 0) {
                        detailsHTML += `
                            <details class="bg-slate-800 border border-slate-600 rounded-lg p-6">
                                <summary class="text-lg font-bold text-slate-300 cursor-pointer hover:text-slate-100">
                                    üìÖ Upcoming Ramp/Exit Closures (${upcomingMinor.length})
                                </summary>
                                <div class="space-y-2 mt-4">
                                    ${upcomingMinor.slice(0, 8).map(closure => `
                                        <a href="${closure.link}" target="_blank" 
                                           class="block p-3 bg-slate-700/50 hover:bg-slate-700 rounded border border-slate-600 hover:border-blue-400 transition-all text-sm">
                                            <div class="text-slate-200">${closure.description}</div>
                                        </a>
                                    `).join('')}
                                </div>
                                ${upcomingMinor.length > 8 ? `
                                    <div class="text-center mt-4">
                                        <a href="${SR520_URL}" target="_blank" 
                                           class="text-blue-400 hover:underline text-sm">
                                            View all ${upcomingMinor.length} upcoming ‚Üí
                                        </a>
                                    </div>
                                ` : ''}
                            </details>
                        `;
                    }
                }
            }

            detailsEl.innerHTML = detailsHTML;

            // Update timestamp
            const now = new Date();
            lastUpdatedEl.textContent = `Last updated: ${now.toLocaleTimeString()}`;
        }

        function build7DayForecast(closures) {
            const forecast = [];
            const today = new Date();
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                
                const dayName = i === 0 ? 'Today' : 
                               i === 1 ? 'Tom' : 
                               date.toLocaleDateString('en-US', { weekday: 'short' });
                
                const dateStr = date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric' });
                
                // Find closures for this day
                const dayClosures = [...closures.today, ...closures.upcoming].filter(closure => {
                    // This is simplified - in reality, you'd need to parse the dates from the closure descriptions
                    // For now, we'll check if today and it's in today's list, or if upcoming
                    if (i === 0) {
                        return closures.today.includes(closure);
                    }
                    // For upcoming days, we'd need to parse dates from descriptions
                    // This is a placeholder - real implementation would parse "Jan 3-4" etc.
                    return false;
                });
                
                const bridgeBlocked = dayClosures.some(c => c.bridgeBlocked);
                
                forecast.push({
                    dayName,
                    date: dateStr,
                    blocked: bridgeBlocked,
                    closures: dayClosures
                });
            }
            
            return forecast;
        }

        function showLoading() {
            document.getElementById('status').innerHTML = `
                <div class="bg-slate-800 border-2 border-slate-600 rounded-2xl p-12 text-center">
                    <div class="text-6xl mb-4">‚è≥</div>
                    <div class="text-2xl text-slate-400">Checking bridge status...</div>
                </div>
            `;
            document.getElementById('details').innerHTML = '';
        }

        function showError() {
            document.getElementById('status').innerHTML = `
                <div class="bg-slate-800 border-2 border-red-500/50 rounded-2xl p-12 text-center">
                    <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                    <div class="text-2xl text-red-400 mb-4">Unable to load status</div>
                    <div class="text-slate-400 mb-6">Check your connection or try again</div>
                    <button onclick="fetchSR520Data()" 
                            class="px-8 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-medium transition-colors">
                        Retry
                    </button>
                </div>
            `;
        }

        // Initial load
        fetchSR520Data();

        // Refresh every 2 minutes
        setInterval(fetchSR520Data, 120000);
    </script>
</body>
</html>
